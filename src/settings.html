<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="icon" type="image/png" href="img/giftyiconweb.png">
  <link href="css/main.css" rel="stylesheet" type="text/css"/>
  <title>Settings</title>

  <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.7.1/jquery.min.js" type="text/javascript"></script>
  <script src="https://www.gstatic.com/firebasejs/7.2.3/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/5.9.0/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/5.8.6/firebase-database.js"></script>
  <script src="https://www.gstatic.com/firebasejs/7.2.3/firebase-analytics.js"></script>
  <script>
    /**
     * Congrats! You're looking at my code, most everything here has been repurposed from Google's Firebase as well as
     * ideas and assets from www.w3schools.com. Google's example can be found at
     * https://github.com/firebase/quickstart-js for anyone interested
     *
     */

    var editBtn;
    var faqBtn;
    var modBtn;
    var offlineSpan;
    var offlineModal;
    var user;
    var userArr = [];
    var userData = [];
    var listeningFirebaseRefs = [];

    function getCurrentUser(){
      user = sessionStorage.getItem("validUser");
      if(user == null){
        window.location.href = "index.html";
      } else {
        console.log("User: " + user + " logged in");
      }
    }

    //Instantiates all data upon loading the webpage
    window.onload = function instantiate() {
      getCurrentUser();

      offlineModal = document.getElementById('offlineModal');
      offlineSpan = document.getElementById("closeOffline");
      editBtn = document.getElementById("edit");
      faqBtn = document.getElementById("faq");
      modBtn = document.getElementById("mod");

      editBtn.onclick = function (){
        navigation(4);
      };

      faqBtn.onclick = function (){
        navigation(5);
      };


      const config = {
        //Oops! This is gone!
      };
      firebase.initializeApp(config);
      firebase.analytics();

      console.log("Logging in anonymously...");
      firebase.auth().signInAnonymously().catch(function (error) {
        // Handle Errors here.
        var errorCode = error.code;
        var errorMessage = error.message;
        // ...
      });

      firebase.auth().onAuthStateChanged(function (user) {
        if (user) {
          // User is signed in.
          var isAnonymous = user.isAnonymous;
          var uid = user.uid;
          // ...
        } else {
          // User is signed out.
          // ...
        }
        // ...
      });


      window.addEventListener("online", function () {
        console.log("Online mode activated, clearing offline notification");
        offlineModal.style.display = "none";
      });

      window.addEventListener("offline", function () {
        var now = 0;
        console.log("Offline mode activated");
        var g = setInterval(function () {
          now = now + 1000;
          if (now >= 5000) {
            try {
              document.getElementById("TestGift").innerHTML = "Loading Failed, Please Connect To Internet";
            } catch (err) {
              console.log("Loading Element Missing");
            }
            console.log("Offline mode notified, showing offline notification");
            offlineModal.style.display = "block";
            clearInterval(g);
          }
        }, 1000);
      });

      //close offlineModal on close
      offlineSpan.onclick = function () {
        console.log("Offline modal closed: Closed manually");
        offlineModal.style.display = "none";
      };

      //close offlineModal on click
      window.onclick = function (event) {
        if (event.target == offlineModal) {
          console.log("Offline modal closed: Outside of modal");
          offlineModal.style.display = "none";
        }
      };

      databaseQuery();

      function databaseQuery() {
        userInitial = firebase.database().ref("users/");

        var fetchPosts = function (postRef) {
          console.log("Fetching data");
          postRef.on('child_added', function (data) {
            userArr.push(data.key);
            userData.push(data);
            if(data.key == user){
              if(data.val().moderatorInt == 1){
                modBtn.style.display = "block";
                modBtn.onclick = function () {
                  navigation(6);
                }
              } else {
              }
            }
          });

          postRef.on('child_changed', function (data) {
          });

          postRef.on('child_removed', function (data) {
          });
        };

        fetchPosts(userInitial);

        listeningFirebaseRefs.push(userInitial);
      }


    };

    function signOut(){
      sessionStorage.clear();
      window.location.href = "index.html";
    }

    function navigation(nav){
      sessionStorage.setItem("validUser", user);
      switch(nav){
        case 0:
          window.location.href = "home.html";
          break;
        case 1:
          window.location.href = "lists.html";
          break;
        case 2:
          window.location.href = "invites.html";
          break;
        case 3:
          window.location.href = "settings.html";
          break;
        case 4:
          //edit user page
          window.location.href = "userAddUpdate.html";
          break;
        case 5:
          window.location.href = "faq.html";
          break;
        case 6:
          alert("Currently Unavailable!");
          break;
        default:
          break;
      }
    }
  </script>

  <div class="topnav">
    <ul>
      <li><div class="cropIcon"><img class="imgIcon" src="img/giftyicon.png"></div></li>
      <div class="break"></div>
      <li><a onclick="navigation(0)">Home</a></li>
      <li><a onclick="navigation(1)">Lists</a></li>
      <li><a onclick="navigation(2)">Invites</a></li>
      <li><a class="active" onclick="navigation(3)">Settings</a></li>
      <li><a class="signOut" onclick="signOut()">Sign Out</a></li>
    </ul>
  </div>
</head>
<body>

<div class="settingsContainer"><br/><br/>
  <span class="settingsBtn" id="edit">Edit Account Info</span> <!--Settings Button A--><br/><br/><br/>
  <span class="settingsBtn" id="faq">Help/FAQ</span> <!--Settings Button B--><br/><br/><br/>
</div>
<span class="modBtn" id="mod">Moderation</span> <!--Settings Button C-->

<!--
Make 3 Buttons, 2 Shown, 1 Hidden
-Edit Account Info (userAddUpdate page, check to make sure page is ready to accept user data)
-Help/FAQ
-Moderation
-->

<div id="myModal" class="modal">
  <div class="modal-content">

    <!--Modal Header-->
    <div class="modal-header">
      <span class="close">&times;</span>
      <h2 id="giftTitle">Loading Title...</h2>
    </div>

    <!--Modal Body-->
    <div class="modal-body">
      <p id="giftLink">Loading Link...</p>
      <p id="giftWhere">Loading Where...</p>
      <p id="giftDescription">Loading Description...</p>
    </div>

    <!--Modal Footer-->
    <div class="modal-footer">
      <h3 style="float: left;padding-left: 10px" id="giftBuy">Buy</h3>
      <h3 style="float: right;padding-right: 10px" id="giftDontBuy">Don't Buy</h3>
    </div>
  </div>
</div>

<div id="offlineModal" class="modal">
  <div class="modal-content">

    <!--Modal Header-->
    <div class="modal-header">
      <span class="close" id="closeOffline">&times;</span>
      <h2>It appears that you are offline!</h2>
    </div>

    <!--Modal Body-->
    <div class="modal-body">
      <p>Please reconnect to the internet in order to use Gifty properly!</p>
    </div>
  </div>
</div>

</body>
</html>
