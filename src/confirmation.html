<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="icon" type="image/png" href="img/giftyiconweb.png">
  <link href="css/main.css" rel="stylesheet" type="text/css"/>
  <title>Confirmation</title>

  <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.7.1/jquery.min.js" type="text/javascript"></script>
  <script src="https://www.gstatic.com/firebasejs/7.2.3/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/5.9.0/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/5.8.6/firebase-database.js"></script>
  <script src="https://www.gstatic.com/firebasejs/7.2.3/firebase-analytics.js"></script>
  <script>
    /**
     * Congrats! You're looking at my code, most everything here has been repurposed from Google's Firebase as well as
     * ideas and assets from www.w3schools.com. Google's example can be found at
     * https://github.com/firebase/quickstart-js for anyone interested
     *
     * ----------------------------------------------------------------
     * ToDo:
     *
     * Test Delete/Update feature
     * Create a button to add new gifts/edit old ones
     *    -Use same modal from before, but with inputs
     *
     * Create login page
     *    -Sift through data to find proper uid and user data
     *    -Find a way to send user id from login to home and so on
     *
     * Complete other pages as needed (Settings, Invites, Lists, etc)
     *
     */

    var confList = [];
    var testGiftInt = 0;
    var offline;
    var offlineInt = 0;
    var userList;
    var userListHTML;
    var listeningFirebaseRefs = [];
    var userName;
    var userUid;
    var userKey;
    var userUName;
    var userShareCode;
    var offlineSpan;
    var offlineModal;
    var user;
    var modal;
    var listNote;
    var inviteNote;
    var inviteData = [];
    var userArr = [];
    var userData = [];
    var userNameArr = [];
    var userUidArr = [];
    var friendNameArr = [];
    var newFriendList = [];
    var newInviteList = [];
    var newOFriendList = [];
    var newOInviteList = [];
    var newConfList = [];
    var inviteArr = [];
    var instantiatedNodes = [];
    var tempInstantiatedNodes = [];
    var friendBool = true;
    var lastSet = 0;
    var currUserName;
    var currUserData;
    var inviteCount = 0;
    var userFound = false;

    function getCurrentUser(){
      user = sessionStorage.getItem("validUser");
      if(user == null || user == undefined){
        window.location.href = "index.html";
      } else {
        console.log("User: " + user + " logged in");
      }
    }

    //Instantiates all data upon loading the webpage
    window.onload = function instantiate() {
      getCurrentUser();

      userList = document.getElementById("userListContainer");
      userListHTML = document.getElementById("userListContainer").innerHTML;
      offlineModal = document.getElementById('offlineModal');
      offlineSpan = document.getElementById("closeOffline");
      listNote = document.getElementById('listNote');
      inviteNote = document.getElementById('inviteNote');


      const config = {
        //Oops! This is gone!
      };
      firebase.initializeApp(config);
      firebase.analytics();

      console.log("Logging in anonymously...");
      firebase.auth().signInAnonymously().catch(function (error) {
        // Handle Errors here.
        var errorCode = error.code;
        var errorMessage = error.message;
        // ...
      });

      firebase.auth().onAuthStateChanged(function (user) {
        if (user) {
          // User is signed in.
          var isAnonymous = user.isAnonymous;
          var uid = user.uid;
          // ...
        } else {
          // User is signed out.
          // ...
        }
        // ...
      });


      window.addEventListener("online", function(){
        console.log("Online mode activated, clearing offline notification");
        offlineModal.style.display = "none";
      });

      window.addEventListener("offline", function() {
        var now = 0;
        console.log("Offline mode activated");
        var g = setInterval(function(){
          now = now + 1000;
          if(now >= 5000){
            try{
              document.getElementById("TestGift").innerHTML = "Loading Failed, Please Connect To Internet";
            } catch(err){
              console.log("Loading Element Missing");
            }
            console.log("Offline mode notified, showing offline notification");
            offlineModal.style.display = "block";
            clearInterval(g);
          }
        }, 1000);
      });

      //close offlineModal on close
      offlineSpan.onclick = function() {
        console.log("Offline modal closed: Closed manually");
        offlineModal.style.display = "none";
      };

      //close offlineModal on click
      window.onclick = function(event) {
        if (event.target == offlineModal) {
          console.log("Offline modal closed: Outside of modal");
          offlineModal.style.display = "none";
        }
      };

      databaseQuery();
      inviteConfirmButton();

      function inviteConfirmButton(){
        var nowConfirm = 0;
        var alternator = 0;
        console.log("Invite Button Feature Active");
        setInterval(function(){
          nowConfirm = nowConfirm + 1000;
          if(nowConfirm >= 3000){
            nowConfirm = 0;
            if(alternator == 0) {
              alternator++;
              document.getElementById("inviteNote").innerHTML = "Confirm";
              inviteNote.style.background = "#00c606";
            } else {
              alternator--;
              document.getElementById("inviteNote").innerHTML = "Invites";
              inviteNote.style.background = "#00ad05";
            }
          }
        }, 1000);
      }

      function databaseQuery() {
        /*
        Things to do here:

        Possible temporary patch, force refresh of data currently in database (completely reload the page)
        -Clear currently loaded modules, reload all

        Test all FOUR permutations at some point (deleting and adding alike), be sure to disable redirect if empty list
        -CUser Has Friends, OUser Has Friends
        -CUser !Friends, OUser Has Friends
        -CUser Has Friends, OUser !Friends
        -CUser !Friends, OUser !Friends
        Ensure that redirect if empty list is reenabled after testing

        Create a floating "add" button, similar to what is needed on the home page (new modal to input username?)
        Create a floating "mail" button
        List user's friends
        Change modal to display user data instead of gift data
        Add "Test Gift" back once all users have been removed
        Trace Add Invite Try/Catches and try to increase efficiency
         */

        var now = 0;
        console.log("Loading Timer Active");
        load = setInterval(function(){
          now = now + 1000;
          if(now >= 10000){
            try{
              document.getElementById("TestGift").innerHTML = "Loading Failed, You Must Not Have Any Friends!";
            } catch(err){
              console.log("Loading Element Missing");
            }
            testGiftInt--;
            console.log("Loading Notification Deployed");
            clearInterval(load);
          }
        }, 1000);

        var userBase = firebase.database().ref("users/");

        var fetchUsers = function (postRef) {
          console.log("Fetching...");
          postRef.on('child_added', function (data) {

            userData.push(data);
            userNameArr.push(data.val().userName.toUpperCase());
            userUidArr.push(data.key);

            if(data.key == user){
              currUserData = data;
              populateConfList(data.val().invites);
              populateList(data, 1);//transfer data, mode 1 (fill list with existing data)
              userFound = true;
            } else if (userFound) {
              populateList(data, 2);//transfer data, mode 2 (fill list with newfound data)
            }

          });

          postRef.on('child_changed', function (data) {
            console.log(data.key + " Changed");

            if (data.key == user) {
              currUserData = data;
              newConfList = data.val().invites;
              try {
                var newConfLength = newConfList.length;
                if (newConfLength != confList.length) {
                  if (userUidArr.indexOf(newConfList[newConfLength]) != -1) {
                    createInviteElement(newConfList[newConfLength]);
                  }
                }
              } catch (err) {
                console.log("Minor Error, User " + data.key + " changed with error: " + err.message);
              }
            } else if (confList.indexOf(data.key) != -1) {
              try {
                updateInviteElement(data);
              } catch (err) {
                console.log("Minor Error, User " + data.key + " changed with error: " + err.message);
              }
            }
            /*
            var index = userData.indexOf(data);
            if (data.key == user) {
              currUserData = data;
            }
            userData[index] = data;
            */
          });

          postRef.on('child_removed', function (data) {
            console.log(data.key + " Removed");
            if (instantiatedNodes.contains(data.key)){
              document.getElementById("user" + data.key).remove();
            }
            /*
            removeInviteElement(data);
            var indexData = userData.indexOf(data);
            userData.remove(indexData);
            console.log(userData);
            */
          });
        };

        function populateConfList(invites){
          for(var i = 0; i < invites.length; i++){
            confList.push(invites[i]);
          }
        }

        function populateList(data, mode) {
          switch(mode){
            //mode 1, begin populating list from existing data
            case 1:
              for(var i = 0; i < confList.length; i++){
                createTempInviteElement(confList[i]);

                if(userUidArr.indexOf(confList[i]) !== -1){
                  var userIndex = userUidArr.indexOf(confList[i]);
                  updateInviteElement(userData[userIndex]);
                }
              }
              break;
            //mode 2, finish populating list from the rest of data flowing in
            case 2:
              if(confList.indexOf(data.key) != -1){
                if(tempInstantiatedNodes.indexOf(data.key) != -1) {
                  updateInviteElement(data);
                } else {
                  createInviteElement(data);
                }
              }
              break;
            default:
              console.log("Hmmm... Something happened internally. Let the developer know if this appears!");
              break;
          }
        }

        function checkData() {
          if (friendBool) {//data that was added before finding user
            for (var i = 0; i < userData.length; i++) {
              if (userData[i].key == user) {//yes
                currUserName = userData[i].val().userName;
                currUserData = userData[i];
                friendKeyArr = userData[i].val().friends;
                inviteArr = userData[i].val().invites;
                for(var a = 0; a < userData.length; a++){
                  try {
                    if (inviteArr.includes(userData[a].key)) {
                      createInviteElement(userData, a);
                      lastSet = a;
                    }
                  } catch (err) {
                    navigation(2);
                  }
                }
                friendBool = false;
              } else {}//no
            }
          } else {//data that was added after finding user
            for(var a = lastSet; a < userData.length; a++){
              if (instantiatedNodes.includes(userData[a].key)){
              } else if (inviteArr.includes(userData[a].key)){
                createInviteElement(userData, a);
              }
            }
          }
        }

        fetchUsers(userBase);
        listeningFirebaseRefs.push(userBase);
      }

      function createTempInviteElement(uid){
        tempInstantiatedNodes.push(uid);

        var liItem = document.createElement("LI");
        liItem.id = "user" + uid;
        liItem.className = "gift";

        liItem.onclick = function (){
          var span = document.getElementsByClassName("close")[0];
          modal = document.getElementById('myModal');
          var userInviteAdd = document.getElementById('userAccept');
          var userInviteDelete = document.getElementById('userDelete');
          var userNameField = document.getElementById('userName');
          var userUNameField = document.getElementById('userUName');
          var userShareCodeField = document.getElementById('userShareCode');

          userNameField.innerHTML = "Loading User " + uid;
          userUNameField.innerHTML = "Loading... Please Wait";
          userShareCodeField.innerHTML = "Loading... Please Wait";

          userInviteAdd.onclick = function(){
            //addInvite(userData[a]);
            alert("User Currently Unavailable");
          };

          userInviteDelete.onclick = function(){
            //deleteInvite(userData[a]);
            alert("User Currently Unavailable");
          };

          //show modal
          modal.style.display = "block";

          //close on close
          span.onclick = function() {
            modal.style.display = "none";
          };

          //close on click
          window.onclick = function(event) {
            if (event.target == modal) {
              modal.style.display = "none";
            }
          }
        };
        var textNode = document.createTextNode(uid);
        liItem.appendChild(textNode);

        userList.insertBefore(liItem, document.getElementById("userListContainer").childNodes[0]);


        if(testGiftInt <= 0) {
          document.getElementById("TestGift").remove();
          console.log("Loading timer cancelled");
          console.log("Offline timer cancelled");
          console.log("TestGift removed");
          testGiftInt=1;
          clearInterval(offline);
          clearInterval(load);
        }
      }

      function updateInviteElement(userData){

        if(tempInstantiatedNodes.indexOf(userData.key) != -1) {//does exist, pop
          var tempIndex = tempInstantiatedNodes.indexOf(userData.key);
          tempInstantiatedNodes.splice(tempIndex, 1);
        }
        if(instantiatedNodes.indexOf(userData.key) == -1) {//does not exist, push
          instantiatedNodes.push(userData.key);
          inviteCount++;
        }

        var userUid = userData.val().uid;
        var userName = userData.val().name;
        var userUName = userData.val().userName;
        var userShareCode = userData.val().shareCode;

        if(userData.val().shareCode == undefined) {
          userShareCode = "This User Does Not Have A Share Code";
        }

        friendNameArr.push(userUName.toUpperCase());


        var liItemUpdate = document.getElementById("user" + userData.key);
        liItemUpdate.innerHTML = userData.val().name;
        liItemUpdate.className = "gift";
        liItemUpdate.onclick = function (){
          var span = document.getElementsByClassName("close")[0];
          modal = document.getElementById('myModal');
          var userInviteAdd = document.getElementById('userAccept');
          var userInviteDelete = document.getElementById('userDelete');
          var userNameField = document.getElementById('userName');
          var userUNameField = document.getElementById('userUName');
          var userShareCodeField = document.getElementById('userShareCode');

          userNameField.innerHTML = userName;
          userUNameField.innerHTML = "User Name: " + userUName;
          userShareCodeField.innerHTML = "Share Code: " + userShareCode;

          userInviteAdd.onclick = function(){
            addInvite(userData);
          };

          userInviteDelete.onclick = function(){
            deleteInvite(userData);
          };

          //show modal
          modal.style.display = "block";

          //close on close
          span.onclick = function() {
            modal.style.display = "none";
          };

          //close on click
          window.onclick = function(event) {
            if (event.target == modal) {
              modal.style.display = "none";
            }
          }
        };
      }

      function createInviteElement(userData){

        if(tempInstantiatedNodes.indexOf(userData.key) != -1) {//does exist, pop
          var tempIndex = tempInstantiatedNodes.indexOf(userData.key);
          tempInstantiatedNodes.splice(tempIndex, 1);
        }
        if(instantiatedNodes.indexOf(userData.key) == -1) {//does not exist, push
          instantiatedNodes.push(userData.key);
          inviteCount++;
        }

        var userUid = userData.val().uid;
        var userName = userData.val().name;
        var userUName = userData.val().userName;
        var userShareCode = userData.val().shareCode;

        if(userData.val().shareCode == undefined) {
          userShareCode = "This User Does Not Have A Share Code";
        }

        friendNameArr.push(userUName.toUpperCase());

        var liItem = document.createElement("LI");
        liItem.id = "user" + userUid;
        liItem.className = "gift";

        liItem.onclick = function (){
          var span = document.getElementsByClassName("close")[0];
          modal = document.getElementById('myModal');
          var userInviteAdd = document.getElementById('userAccept');
          var userInviteDelete = document.getElementById('userDelete');
          var userNameField = document.getElementById('userName');
          var userUNameField = document.getElementById('userUName');
          var userShareCodeField = document.getElementById('userShareCode');

          userNameField.innerHTML = userName;
          userUNameField.innerHTML = "User Name: " + userUName;
          userShareCodeField.innerHTML = "Share Code: " + userShareCode;

          userInviteAdd.onclick = function(){
            addInvite(userData);
          };

          userInviteDelete.onclick = function(){
            deleteInvite(userData);
          };

          //show modal
          modal.style.display = "block";

          //close on close
          span.onclick = function() {
            modal.style.display = "none";
          };

          //close on click
          window.onclick = function(event) {
            if (event.target == modal) {
              modal.style.display = "none";
            }
          }
        };
        var textNode = document.createTextNode(userName);
        liItem.appendChild(textNode);

        userList.insertBefore(liItem, document.getElementById("userListContainer").childNodes[0]);


        if(testGiftInt <= 0) {
          document.getElementById("TestGift").remove();
          console.log("Loading timer cancelled");
          console.log("Offline timer cancelled");
          console.log("TestGift removed");
          testGiftInt=1;
          clearInterval(offline);
          clearInterval(load);
        }
      }

      function removeInviteElement(uid){
        document.getElementById("user" + uid).remove();
      }


















      function addInvite(uid){
        var uFriendBool = false;
        var uInviteBool = false;
        var oFriendBool = false;
        var oInviteBool = false;
        var uFriends = currUserData.val().friends;
        var uInvites = currUserData.val().invites;
        var oFriends = uid.val().friends;
        var oInvites = uid.val().invites;

        //console.log("uFriends " + uFriends);
        if(uFriends!==undefined)
          newFriendList = uFriends;
        newFriendList.push(uid.key);
        //console.log("new " + newFriendList);
        firebase.database().ref("users/" + user).update({friends:newFriendList});

        //remove other user from currUser invites by catching the invites and reuploading an array
        //console.log("uInvites " + uInvites);
        //console.log("Goal: Remove " + uid.key);
        newInviteList = uInvites;
        var inviteIndex = newInviteList.indexOf(uid.key);
        if(newInviteList.length > 1) {
          newInviteList.splice(inviteIndex, 1);
          firebase.database().ref("users/" + user + "/invites/").update(newInviteList);
        }
        //console.log("newI " + newInviteList);


        //console.log("oFriends " + oFriends);
        if(oFriends!==undefined)
          newOFriendList = oFriends;
        newOFriendList.push(user);//This is claimed to "Not be a function", check and verify why this isn't working
        //console.log("newO " + newOFriendList);
        firebase.database().ref("users/" + uid.key).update({friends:newOFriendList});

        if(instantiatedNodes.indexOf(uid.key) != 1) {
          var tempIndex = instantiatedNodes.indexOf(uid.key);
          instantiatedNodes.splice(tempIndex, 1);
        }

        if(confList.indexOf(uid.key) != 1) {
          var tempIndex = confList.indexOf(uid.key);
          confList.splice(tempIndex, 1);
        }

        newFriendList = [];
        newOFriendList = [];
        document.getElementById("user" + uid.key).remove();
        modal.style.display = "none";
        inviteCount--;
        if(inviteCount == 0) {
          navigation(2);
        }
      }

      function reorganizeUserInvites(invites, id){//fix remove friend like this too
        var invitesMax = invites.length - 1;
        if(id < invitesMax){
          //console.log(invites);
          //console.log(id);
          invites.splice(id,1);
          //console.log(invites);
          //console.log(id);
          firebase.database().ref("users/" + user + "/invites/" + invites);
        } else {
          firebase.database().ref("users/" + user + "/invites/" + id).remove();
        }
      }











      //delete invite needs to be updated

      function deleteInvite(uid) {
        var invites = currUserData.val().invites;
        var id = invites.indexOf(uid.key);

        //Keep this
        if(instantiatedNodes.indexOf(uid.key) != 1) {
          var tempIndex = instantiatedNodes.indexOf(uid.key);
          instantiatedNodes.splice(tempIndex, 1);
        }

        //Keep this
        if(confList.indexOf(uid.key) != 1) {
          var tempIndex = confList.indexOf(uid.key);
          confList.splice(tempIndex, 1);
        }

        document.getElementById("user" + uid.key).remove();
        inviteCount--;

        //dont use this
        //reorganizeUserInvites(invites, id);
        modal.style.display = "none";
        if(inviteCount == 0){
          navigation(2);
        }
      }
    };

    function signOut(){
      sessionStorage.clear();
      window.location.href = "index.html";
    }

    function navigation(nav){
      sessionStorage.setItem("validUser", user);
      switch(nav){
        case 0:
          window.location.href = "home.html";
          break;
        case 1:
          window.location.href = "lists.html";
          break;
        case 2:
          window.location.href = "invites.html";
          break;
        case 3:
          window.location.href = "settings.html";
          break;
        case 4:
          window.location.href = "confirmation.html";
          break;
        default:
          break;
      }
    }
  </script>

  <div class="topnav">
    <ul>
      <li><div class="cropIcon"><img class="imgIcon" src="img/giftyicon.png"></div></li>
      <div class="break"></div>
      <li><a onclick="navigation(0)">Home</a></li>
      <li><a onclick="navigation(1)" id="listNote">Lists</a></li>
      <li><a class="active" onclick="navigation(2)" id="inviteNote">Invites</a></li>
      <li><a onclick="navigation(3)">Settings</a></li>
      <li><a class="signOut" onclick="signOut()">Sign Out</a></li>
    </ul>
  </div>
</head>
<body>

<ul id="userListContainer" class="giftList">
  <li class="gift" id="TestGift">Loading...</li> <!--Display loading failed if it takes longer than 10s-->
</ul>

<div id="myModal" class="modal">
  <div class="modal-content">

    <!--Modal Header-->
    <div class="modal-header">
      <span class="close">&times;</span>
      <h2 id="userName">Loading Name...</h2>
    </div>

    <!--Modal Body-->
    <div class="modal-body">
      <p id="userUName">Loading UserName...</p>
      <p id="userShareCode">Loading Where...</p>
    </div>

    <!--Modal Footer-->
    <div class="modal-footer">
      <h3 style="float: left;padding-left: 10px" id="userAccept">Accept Invite</h3>
      <h3 style="float: right;padding-right: 10px" id="userDelete">Delete Invite</h3>
    </div>
  </div>
</div>

<div id="offlineModal" class="modal">
  <div class="modal-content">

    <!--Modal Header-->
    <div class="modal-header">
      <span class="close" id="closeOffline">&times;</span>
      <h2>It appears that you are offline!</h2>
    </div>

    <!--Modal Body-->
    <div class="modal-body">
      <p>Please reconnect to the internet in order to use Gifty properly!</p>
    </div>
  </div>
</div>

</body>
</html>
