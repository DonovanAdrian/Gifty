<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="icon" type="image/png" href="img/giftyiconweb.png">
  <link href="css/main.css" rel="stylesheet" type="text/css"/>
  <title>Invites</title>

  <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.7.1/jquery.min.js" type="text/javascript"></script>
  <script src="https://www.gstatic.com/firebasejs/7.2.3/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/5.9.0/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/5.8.6/firebase-database.js"></script>
  <script src="https://www.gstatic.com/firebasejs/7.2.3/firebase-analytics.js"></script>
  <script>
    /**
     * Congrats! You're looking at my code, most everything here has been repurposed from Google's Firebase as well as
     * ideas and assets from www.w3schools.com. Google's example can be found at
     * https://github.com/firebase/quickstart-js for anyone interested
     *
     * ----------------------------------------------------------------
     * ToDo:
     *
     * Test Delete/Update feature
     * Create a button to add new gifts/edit old ones
     *    -Use same modal from before, but with inputs
     *
     * Create login page
     *    -Sift through data to find proper uid and user data
     *    -Find a way to send user id from login to home and so on
     *
     * Complete other pages as needed (Settings, Invites, Lists, etc)
     *
     */

    var testGiftInt = 0;
    var offline;
    var offlineInt = 0;
    var userList;
    var userListHTML;
    var listeningFirebaseRefs = [];
    var offlineSpan;
    var offlineModal;
    var userInviteModal;
    var confirmUserModal;
    var addUserBtn;
    var user;
    var userData = [];
    var confList = [];
    var newConfList = [];
    var newInvite;
    var listNote;
    var inviteNote;
    var friendBool = true;
    var friendKeyArr = [];
    var friendNameArr = [];
    var userNameArr = [];
    var userUidArr = [];
    var inviteArr = [];
    var instantiatedNodes = [];
    var tempInstantiatedNodes = [];
    var lastSet = 0;
    var currUserName;
    var currUserData;
    var userInput;
    var inviteCount = 0;
    var userFound = false;

    function getCurrentUser(){
      user = sessionStorage.getItem("validUser");
      if(user == null || user == undefined){
        window.location.href = "index.html";
      } else {
        console.log("User: " + user + " logged in");
      }
    }

    //Instantiates all data upon loading the webpage
    window.onload = function instantiate() {
      getCurrentUser();

      userList = document.getElementById("userListContainer");
      userListHTML = document.getElementById("userListContainer").innerHTML;
      offlineModal = document.getElementById('offlineModal');
      offlineSpan = document.getElementById("closeOffline");
      userInviteModal = document.getElementById('userModal');
      confirmUserModal = document.getElementById('confirmModal');
      listNote = document.getElementById('listNote');
      inviteNote = document.getElementById('inviteNote');
      newInvite = document.getElementById('newInviteIcon');
      addUserBtn = document.getElementById('addUser');


      const config = {
        //Oops! This is gone!
      };
      firebase.initializeApp(config);
      firebase.analytics();

      console.log("Logging in anonymously...");
      firebase.auth().signInAnonymously().catch(function (error) {
        // Handle Errors here.
        var errorCode = error.code;
        var errorMessage = error.message;
        // ...
      });

      firebase.auth().onAuthStateChanged(function (user) {
        if (user) {
          // User is signed in.
          var isAnonymous = user.isAnonymous;
          var uid = user.uid;
          // ...
        } else {
          // User is signed out.
          // ...
        }
        // ...
      });


      window.addEventListener("online", function(){
        console.log("Online mode activated, clearing offline notification");
        offlineModal.style.display = "none";
      });

      window.addEventListener("offline", function() {
        var now = 0;
        console.log("Offline mode activated");
        var g = setInterval(function(){
          now = now + 1000;
          if(now >= 5000){
            try{
              document.getElementById("TestGift").innerHTML = "Loading Failed, Please Connect To Internet";
            } catch(err){
              console.log("Loading Element Missing");
            }
            console.log("Offline mode notified, showing offline notification");
            offlineModal.style.display = "block";
            clearInterval(g);
          }
        }, 1000);
      });

      //close offlineModal on close
      offlineSpan.onclick = function() {
        console.log("Offline modal closed: Closed manually");
        offlineModal.style.display = "none";
      };

      //close offlineModal on click
      window.onclick = function(event) {
        if (event.target == offlineModal) {
          console.log("Offline modal closed: Outside of modal");
          offlineModal.style.display = "none";
        }
      };

      newInvite.onclick = function() {
        sessionStorage.setItem("validUser", user);
        window.location.href = "confirmation.html";
      };

      databaseQuery();

      function databaseQuery() {
        /*
        Things to do here:

        Possible temporary patch, force refresh of data currently in database (completely reload the page)
        -Clear currently loaded modules, reload all

        Verify that removal of access operates properly and friends lists are restored (check before and after accessRemove)

        Create a floating "add" button, similar to what is needed on the home page (new modal to input username?)
        Create a note modal that confirms invite sent
        Suppress Duplicate Invites/Friends (Friend Checking)
        Suppress Pending Invites, don't add an invite that you're already waiting for (does it matter?)

        Use a timer to tell how long it takes to load all users into profile (if it takes more than 5 seconds make
        the default time 10 seconds to be safe) Use this time to send invites (wait until user is sent invite)
          -As users are coming in from invitee's invite list, wait ^ time until next user. If ^ time is exceeded, add
          at next int depending on how many users are in invite list
         */

        var now = 0;
        console.log("Loading Timer Active");
        load = setInterval(function(){
          now = now + 1000;
          if(now >= 10000){
            generateEmptyFriendsList();
          }
        }, 1000);

        var userBase = firebase.database().ref("users/");

        var fetchUsers = function (postRef) {
          console.log("Fetching...");
          postRef.on('child_added', function (data) {

            userData.push(data);
            userNameArr.push(data.val().userName.toUpperCase());
            userUidArr.push(data.key);

            if(data.key == user){

              inviteArr = data.val().invites;
              try {
                if (inviteArr.length > 0 && !inviteArr.includes("")) {
                  newInvite.style.display = "block";
                  inviteNote.style.background = "#ff3923";
                }
              } catch(err){
                console.log("Error Finding Invites");
              }

              currUserData = data;
              currUserName = data.val().userName;

              if(data.val().friends !== undefined) {
                var cleanedArray = cleanArray(data.val().friends);
                firebase.database().ref("users/" + user).update({
                  friends: cleanedArray
                });

                populateConfList(data.val().friends);
                populateList(data, 1);//transfer data, mode 1 (fill list with existing data)
                userFound = true;
              } else {
                generateEmptyFriendsList();
              }
            } else if (userFound) {
              populateList(data, 2);//transfer data, mode 2 (fill list with newfound data)
            }


            //checkData();
          });

          postRef.on('child_changed', function (data) {
            console.log(data.key + " Changed");
            if(data.key == user) {
              if (confList.indexOf(data.key) !== -1) {
                updateInviteElement(data);
              } else if (data.key == user) {
                newConfList = data.val().invites;
                try {
                  var newConfLength = newConfList.length;
                  if (newConfLength != confList.length) {
                    if (userUidArr.indexOf(newConfList[newConfLength]) != -1) {
                      createInviteElement(newConfList[newConfLength]);
                    }
                  }
                } catch (err) {

                }
              }
              /*
              var index = userData.indexOf(data);
              if(data.key == user) {
                currUserData = data;
              }
              userData[index] = data;
              */
            }
          });

          postRef.on('child_removed', function (data) {
            console.log(data.key + " Removed");
            if (instantiatedNodes.contains(data.key)){
              document.getElementById("user" + data.key).remove();
            }
          });
        };

        fetchUsers(userBase);
        listeningFirebaseRefs.push(userBase);

        function populateConfList(invites){
          for(var i = 0; i < invites.length; i++){
            confList.push(invites[i]);
          }
        }

        function populateList(data, mode) {
          switch(mode){
            //mode 1, begin populating list from existing data
            case 1:
              for(var i = 0; i < confList.length; i++){
                createTempInviteElement(confList[i]);

                if(userUidArr.indexOf(confList[i]) !== -1){
                  var userIndex = userUidArr.indexOf(confList[i]);
                  updateInviteElement(userData[userIndex]);
                }
              }
              break;
            //mode 2, finish populating list from the rest of data flowing in
            case 2:
              if(confList.indexOf(data.key) != -1){
                if(tempInstantiatedNodes.indexOf(data.key) != -1) {
                  updateInviteElement(data);
                } else {
                  createInviteElement(data);
                }
              }
              break;
            default:
              console.log("Hmmm... Something happened internally. Let the developer know if this appears!");
              break;
          }
        }
      }

      function createTempInviteElement(uid){
        console.log("Temp Invite Created");
        tempInstantiatedNodes.push(uid);

        console.log(tempInstantiatedNodes);

        var liItem = document.createElement("LI");
        liItem.id = "user" + uid;
        liItem.className = "gift";

        liItem.onclick = function (){
          var span = document.getElementsByClassName("close")[0];
          modal = document.getElementById('myModal');
          var userInviteAdd = document.getElementById('userAccept');
          var userInviteDelete = document.getElementById('userDelete');
          var userInviteRemove = document.getElementById('userInviteRemove');
          var userNameField = document.getElementById('userName');
          var userUNameField = document.getElementById('userUName');
          var userShareCodeField = document.getElementById('userShareCode');

          userNameField.innerHTML = "Loading User " + uid;
          userUNameField.innerHTML = "Loading... Please Wait";
          userShareCodeField.innerHTML = "Loading... Please Wait";

          userInviteRemove.onclick = function(){
          };

          //show modal
          modal.style.display = "block";

          //close on close
          span.onclick = function() {
            modal.style.display = "none";
          };

          //close on click
          window.onclick = function(event) {
            if (event.target == modal) {
              modal.style.display = "none";
            }
          }
        };
        var textNode = document.createTextNode(uid);
        liItem.appendChild(textNode);

        userList.insertBefore(liItem, document.getElementById("userListContainer").childNodes[0]);


        if(testGiftInt <= 0) {
          addUserBtn.innerHTML = "Invite User";
          document.getElementById("TestGift").remove();
          console.log("Loading timer cancelled");
          console.log("Offline timer cancelled");
          console.log("TestGift removed");
          testGiftInt=1;
          clearInterval(offline);
          clearInterval(load);

          generateAddUserBtn();
        }
      }

      function updateInviteElement(userData){

        console.log("U: " + userData.val().name);

        if(tempInstantiatedNodes.indexOf(userData.key) != 1) {
          var tempIndex = tempInstantiatedNodes.indexOf(userData.key);
          tempInstantiatedNodes.splice(tempIndex, 1);
        }
        if(instantiatedNodes.indexOf(userData.key) != -1)
          instantiatedNodes.push(userData.key);

        console.log(instantiatedNodes);

        var userUid = userData.val().uid;
        var userName = userData.val().name;
        var userUName = userData.val().userName;
        var userShareCode = userData.val().shareCode;

        if(userData.val().shareCode == undefined) {
          userShareCode = "This User Does Not Have A Share Code";
        }

        friendNameArr.push(userUName.toUpperCase());


        var liItemUpdate = document.getElementById("user" + userData.key);
        liItemUpdate.innerHTML = userData.val().name;
        liItemUpdate.className = "gift";
        liItemUpdate.onclick = function (){
          var span = document.getElementsByClassName("close")[0];
          modal = document.getElementById('myModal');
          var userInviteAdd = document.getElementById('userAccept');
          var userInviteDelete = document.getElementById('userDelete');
          var userInviteRemove = document.getElementById('userInviteRemove');
          var userNameField = document.getElementById('userName');
          var userUNameField = document.getElementById('userUName');
          var userShareCodeField = document.getElementById('userShareCode');

          userNameField.innerHTML = userName;
          userUNameField.innerHTML = "User Name: " + userUName;
          userShareCodeField.innerHTML = "Share Code: " + userShareCode;

          userInviteRemove.onclick = function(){
            modal.style.display = "none";
            deleteFriend(userUid);
          };

          //show modal
          modal.style.display = "block";

          //close on close
          span.onclick = function() {
            modal.style.display = "none";
          };

          //close on click
          window.onclick = function(event) {
            if (event.target == modal) {
              modal.style.display = "none";
            }
          }
        };
      }

      function createInviteElement(userData){
        console.log("C: " + userData.val().name);
        inviteCount++;

        if(tempInstantiatedNodes.indexOf(userData.key) != 1) {
          var tempIndex = tempInstantiatedNodes.indexOf(userData.key);
          tempInstantiatedNodes.splice(tempIndex, 1);
        }
        if(instantiatedNodes.indexOf(userData.key) != -1)
          instantiatedNodes.push(userData.key);

        console.log(instantiatedNodes);

        var userUid = userData.val().uid;
        var userName = userData.val().name;
        var userUName = userData.val().userName;
        var userShareCode = userData.val().shareCode;

        if(userData.val().shareCode == undefined) {
          userShareCode = "This User Does Not Have A Share Code";
        }

        friendNameArr.push(userUName.toUpperCase());

        var liItem = document.createElement("LI");
        liItem.id = "user" + userUid;
        liItem.className = "gift";

        liItem.onclick = function (){
          var span = document.getElementsByClassName("close")[0];
          modal = document.getElementById('myModal');
          var userInviteAdd = document.getElementById('userAccept');
          var userInviteDelete = document.getElementById('userDelete');
          var userInviteRemove = document.getElementById('userInviteRemove');
          var userNameField = document.getElementById('userName');
          var userUNameField = document.getElementById('userUName');
          var userShareCodeField = document.getElementById('userShareCode');

          userNameField.innerHTML = userName;
          userUNameField.innerHTML = "User Name: " + userUName;
          userShareCodeField.innerHTML = "Share Code: " + userShareCode;

          userInviteRemove.onclick = function(){
            modal.style.display = "none";
            deleteFriend(userUid);
          };

          //show modal
          modal.style.display = "block";

          //close on close
          span.onclick = function() {
            modal.style.display = "none";
          };

          //close on click
          window.onclick = function(event) {
            if (event.target == modal) {
              modal.style.display = "none";
            }
          }
        };
        var textNode = document.createTextNode(userName);
        liItem.appendChild(textNode);

        userList.insertBefore(liItem, document.getElementById("userListContainer").childNodes[0]);


        if(testGiftInt <= 0) {
          addUserBtn.innerHTML = "Invite User";
          document.getElementById("TestGift").remove();
          console.log("Loading timer cancelled");
          console.log("Offline timer cancelled");
          console.log("TestGift removed");
          testGiftInt=1;
          clearInterval(offline);
          clearInterval(load);

          generateAddUserBtn();
        }
      }

      function cleanArray(array){
        try {
          for (var i = 0; i < array.length; i++){
            if(array[i] == undefined){
              array.splice(i, 1);
            }
          }

          return array;
        } catch (err) {
          console.log("Array Error, Check Log: " + err);
        }
      }

      /*
      function createInviteElement(userData, a){
        instantiatedNodes.push(userData[a].key);

        var userUid = userData[a].val().uid;
        var userName = userData[a].val().name;
        var userUName = userData[a].val().userName;
        var userShareCode = userData[a].val().shareCode;

        friendNameArr.push(userUName.toUpperCase());

        var liItem = document.createElement("LI");
        liItem.id = "user" + userUid;
        liItem.className = "gift";

        liItem.onclick = function (){
          var span = document.getElementsByClassName("close")[0];
          var modal = document.getElementById('myModal');
          var userInviteRemove = document.getElementById('userInviteRemove');
          var userNameField = document.getElementById('userName');
          var userUNameField = document.getElementById('userUName');
          var userShareCodeField = document.getElementById('userShareCode');

          userNameField.innerHTML = userName;
          userUNameField.innerHTML = "User Name: " + userUName;
          userShareCodeField.innerHTML = "Share Code: " + userShareCode;

          userInviteRemove.onclick = function(){
            modal.style.display = "none";
            removeFriendElement(userData[a]);
          };

          //show modal
          modal.style.display = "block";

          //close on close
          span.onclick = function() {
            modal.style.display = "none";
          };

          //close on click
          window.onclick = function(event) {
            if (event.target == modal) {
              modal.style.display = "none";
            }
          }
        };
        var textNode = document.createTextNode(userName);
        liItem.appendChild(textNode);

        userList.insertBefore(liItem, document.getElementById("userListContainer").childNodes[0]);


        if(testGiftInt <= 0) {
          addUserBtn.innerHTML = "Invite User";
          document.getElementById("TestGift").remove();
          console.log("Loading timer cancelled");
          console.log("Offline timer cancelled");
          console.log("TestGift removed");
          testGiftInt=1;
          clearInterval(offline);
          clearInterval(load);

          generateAddUserBtn();
        }
      }
      */

      function checkData() {
        if (friendBool) {//data that was added before finding user
          for (var i = 0; i < userData.length; i++) {
            if (userData[i].key == user) {//yes
              currUserName = userData[i].val().userName;
              currUserData = userData[i];
              friendKeyArr = userData[i].val().friends;
              inviteArr = userData[i].val().invites;
              try {
                if (inviteArr.length > 0 && !inviteArr.includes("")) {
                  newInvite.style.display = "block";
                  inviteNote.style.background = "#ff3923";
                  generateEmptyFriendsList();
                } else if (inviteArr.length > 0) {
                  generateEmptyFriendsList();
                }
              } catch (err) {//stop load timer
                generateEmptyFriendsList();
              }
              for(var a = 0; a < userData.length; a++){
                try {
                  if (friendKeyArr.includes(userData[a].key)) {
                    createInviteElement(userData, a);
                    lastSet = a;
                  }
                } catch (err) {
                  //in case of new user
                }
              }
              friendBool = false;
            } else {}//no
          }
        } else {//data that was added after finding user
          for(var a = lastSet; a < userData.length; a++){
            try {
              if (instantiatedNodes.includes(userData[a].key)) {
              } else if (friendKeyArr.includes(userData[a].key)) {
                createInviteElement(userData, a);
              }
            } catch (err) {
              //in case of new user
            }
          }
        }
      }

      //delete friend needs to be updated

      function deleteFriend(uid) {
        var invites = currUserData.val().invites;
        var id = invites.indexOf(uid.key);
        document.getElementById("user" + uid.key).remove();
        inviteCount--;
        reorganizeUserFriends(invites, id);
        modal.style.display = "none";
        if(inviteCount == 0){
          navigation(2);
        } else {
          navigation(4);
        }
      }

      function reorganizeUserFriends(invites, id){//fix remove friend like this too
        var invitesMax = invites.length - 1;
        if(id < invitesMax){
          //console.log(invites);
          //console.log(id);
          invites.splice(id,1);
          //console.log(invites);
          //console.log(id);
          firebase.database().ref("users/" + user + "/friends/" + invites);
        } else {
          firebase.database().ref("users/" + user + "/friends/" + id).remove();
        }
      }
























      function generateAddUserBtn(){
        addUserBtn.onclick = function() {
          var addSpan = document.getElementsByClassName("close")[1];
          var addBtn = document.getElementById('addInvite');
          var cancelBtn = document.getElementById('cancelInvite');
          var inviteInfo = document.getElementById('inviteInfo');
          userInput = document.getElementById('userNameInp');

          userInviteModal.style.display = "block";

          addBtn.onclick = function() {//check for pending invite!!!
            inviteInfo.innerHTML = "";
            if(userInput.value == ""){
              inviteInfo.innerHTML = "User Name Field Empty, Please Try Again!";
            } else if (friendNameArr.includes(userInput.value.toUpperCase())) {
              inviteInfo.innerHTML = "That User Is Already Your Friend, Please Try Again!";
            } else if (currUserName.toUpperCase() == userInput.value.toUpperCase()){
              inviteInfo.innerHTML = "You Cannot Invite Yourself, Please Try Again!";
            } else if (userNameArr.includes(userInput.value.toUpperCase())) {
              var inviteId = userNameArr.indexOf(userInput.value.toUpperCase());
              var otherUserInviteKey = userData[inviteId].key;
              var otherUserInvites = userData[inviteId].val().invites;
              try {
                if (currUserData.val().invites.includes(otherUserInviteKey)) {
                  inviteInfo.innerHTML = "This User Already Sent You An Invite, Please Try Again!";
                } else if (otherUserInvites.includes(user)) {
                  inviteInfo.innerHTML = "You Already Sent This User An Invite, Please Try Again!";
                } else {
                  generateConfirmDialog();
                }
              } catch (err) {
                generateConfirmDialog();
              }
            } else if (userInput.value.toUpperCase() == "USER NAME BELOW"){
              inviteInfo.innerHTML = "Very Funny, Please Enter A User Name";
            } else if (userInput.value.toUpperCase() == "A USER NAME"){
              inviteInfo.innerHTML = "Listen Here, Please Input Something Serious";
            } else if (userInput.value.toUpperCase() == "SOMETHING SERIOUS"){
              inviteInfo.innerHTML = "You're Just Mocking Me At This Point";
              //click to redirect elsewhere
            } else {
              inviteInfo.innerHTML = "That User Name Does Not Exist, Please Try Again!";
            }
          };

          cancelBtn.onclick = function() {
            userInviteModal.style.display = "none";
          };

          //close on close
          addSpan.onclick = function() {
            userInviteModal.style.display = "none";
          };

          //close on click
          window.onclick = function(event) {
            if (event.target == userInviteModal) {
              userInviteModal.style.display = "none";
            }
          }
        };
      }

      function generateConfirmDialog(){
        var confirmSpan = document.getElementsByClassName("close")[2];
        var inviteConfirm = document.getElementById('inviteConfirm');
        var inviteDeny = document.getElementById('inviteDeny');
        var confUserName = document.getElementById('confUserName');

        confUserName.innerHTML = "Did you mean to add \"" + userInput.value + "\"?";
        userInviteModal.style.display = "none";
        confirmUserModal.style.display = "block";

        inviteConfirm.onclick = function () {
          var userLocation = userNameArr.indexOf(userInput.value.toUpperCase());
          inviteUserDB(userData[userLocation]);
          confirmUserModal.style.display = "none";
        };

        inviteDeny.onclick = function () {
          confirmUserModal.style.display = "none";
          userInviteModal.style.display = "block";
        };

        //close on close
        confirmSpan.onclick = function () {
          confirmUserModal.style.display = "none";
        };

        //close on click
        window.onclick = function (event) {
          if (event.target == confirmUserModal) {
            confirmUserModal.style.display = "none";
          }
        }
      }

      function generateEmptyFriendsList(){
        try{
          document.getElementById("TestGift").innerHTML = "No Friends Found! Invite Some Friends With The Button Below!";
        } catch(err){
          console.log("Loading Element Missing");
        }

        if(testGiftInt <= 0) {
          addUserBtn.innerHTML = "Invite User";
          console.log("Loading timer cancelled");
          console.log("Offline timer cancelled");
          clearInterval(offline);
          clearInterval(load);

          generateAddUserBtn();
        }

        console.log("Loading Notification Deployed");
        clearInterval(load);
      }

      //note
      function removeFriendElement(uid) {
        document.getElementById("user" + uid.key).remove();
        var userFriends = currUserData.val().friends;
        var userFriendsId = userFriends.indexOf(uid.key);
        var friends = uid.val().friends;
        var friendId = friends.indexOf(user);
        reorganizeFriends(userFriends, userFriendsId, friends, friendId, uid);
        navigation(2);
      }

      function reorganizeFriends(uFriends, ui, friends, id, uid){
        //current user's friend list
        var uFriendsMax = uFriends.length - 1;
        if(ui < uFriendsMax) {
          //console.log(uFriends);
          //console.log("Removing " + ui);
          uFriends.splice(ui, 1);
          //console.log(uFriends);
          for(var i = 0; i < uFriends.length; i++) {
            //console.log(uFriends[i]);
            firebase.database().ref("users/" + user + "/friends/" + i).set(uFriends[i]);
          }
          firebase.database().ref("users/" + user + "/friends/" + uFriends.length).remove();
        } else {
          //console.log("Removing Last Friend " + ui);
          firebase.database().ref("users/" + user + "/friends/" + ui).remove();
        }

        //other user's friend list
        var friendsMax = friends.length - 1;
        if(id < friendsMax) {
          //console.log(friends);
          //console.log("Removing " + id);
          friends.splice(id, 1);
          //console.log(friends);
          for(var i = 0; i < friends.length; i++) {
            //console.log(friends[i]);
            firebase.database().ref("users/" + uid.key + "/friends/" + i).set(friends[i]);
          }
          firebase.database().ref("users/" + uid.key + "/friends/" + friends.length).remove();
        } else {
          //console.log("Removing Last Friend " + id);
          firebase.database().ref("users/" + uid.key + "/friends/" + id).remove();
        }
      }

      function inviteUserDB(uid) {//rekey to work with new user data scheme
        try {
          var invites = uid.val().invites;
          console.log(typeof invites + invites);
          var id = invites.length; //if invites.length throws an error, invites list does not exist, create new one
          uid = uid.key;
          firebase.database().ref("users/" + uid + "/invites/" + id).set(user);
        } catch (err){//there is no invite folder
          firebase.database().ref("users/" + uid.key).update({invites:{0:user}});
        }
        navigation(2);
      }
    };

    function signOut(){
      sessionStorage.clear();
      window.location.href = "index.html";
    }

    function navigation(nav){
      sessionStorage.setItem("validUser", user);
      switch(nav){
        case 0:
          window.location.href = "home.html";
          break;
        case 1:
          window.location.href = "lists.html";
          break;
        case 2:
          window.location.href = "invites.html";
          break;
        case 3:
          window.location.href = "settings.html";
          break;
        default:
          break;
      }
    }
  </script>

  <div class="topnav">
    <ul>
      <li><div class="cropIcon"><img class="imgIcon" src="img/giftyicon.png"></div></li>
      <div class="break"></div>
      <li><a onclick="navigation(0)">Home</a></li>
      <li><a onclick="navigation(1)" id="listNote">Lists</a></li>
      <li><a class="active" onclick="navigation(2)" id="inviteNote">Invites</a></li>
      <li><a onclick="navigation(3)">Settings</a></li>
      <li><a class="signOut" onclick="signOut()">Sign Out</a></li>
    </ul>
  </div>
</head>
<body>

<ul id="userListContainer" class="giftList">
  <li class="gift" id="TestGift">Loading...</li> <!--Display loading failed if it takes longer than 10s-->
</ul>

<span class="addBtn" id="addUser">Loading... Please Wait</span>

<img src="img/newInvite.png" class="newInvite" id="newInviteIcon">

<div id="myModal" class="modal">
  <div class="modal-content">

    <!--Modal Header-->
    <div class="modal-header">
      <span class="close">&times;</span>
      <h2 id="userName">Loading Name...</h2>
    </div>

    <!--Modal Body-->
    <div class="modal-body">
      <p id="userUName">Loading UserName...</p>
      <p id="userShareCode">Loading Where...</p>
    </div>

    <!--Modal Footer-->
    <div class="modal-footer">
      <h3 style="float: left;padding-left: 10px" id="blank"></h3>
      <h3 style="float: right;padding-right: 10px" id="userInviteRemove">Remove Access</h3>
    </div>
  </div>
</div>

<div id="userModal" class="modal">
  <div class="modal-content">

    <!--Modal Header-->
    <div class="modal-header">
      <span class="close">&times;</span>
      <h2>Enter User Name Below</h2>
    </div>

    <!--Modal Body-->
    <div class="modal-body">
      <p></p>
      <input type="text" id="userNameInp" placeholder="User Name" class="giftInp">
      <p id="inviteInfo"></p>
    </div>

    <!--Modal Footer-->
    <div class="modal-footer">
      <h3 style="float: left;padding-left: 10px" id="addInvite">Add</h3>
      <h3 style="float: right;padding-right: 10px" id="cancelInvite">Cancel</h3>
    </div>
  </div>
</div>

<div id="confirmModal" class="modal">
  <div class="modal-content">

    <!--Modal Header-->
    <div class="modal-header">
      <span class="close">&times;</span>
      <h2>Confirm User Name Below</h2>
    </div>

    <!--Modal Body-->
    <div class="modal-body">
      <p id="confUserName">Loading User Name...</p>
    </div>

    <!--Modal Footer-->
    <div class="modal-footer">
      <h3 style="float: left;padding-left: 10px" id="inviteConfirm">Yes</h3>
      <h3 style="float: right;padding-right: 10px" id="inviteDeny">No</h3>
    </div>
  </div>
</div>

<div id="offlineModal" class="modal">
  <div class="modal-content">

    <!--Modal Header-->
    <div class="modal-header">
      <span class="close" id="closeOffline">&times;</span>
      <h2>It appears that you are offline!</h2>
    </div>

    <!--Modal Body-->
    <div class="modal-body">
      <p>Please reconnect to the internet in order to use Gifty properly!</p>
    </div>
  </div>
</div>

</body>
</html>
